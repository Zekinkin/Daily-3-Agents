name: ğŸ¤– æ¯æ—¥å†…å®¹é›†ä¸­ç”Ÿæˆ (æ™šé—´å¤‡ç¨¿)

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 21:00 = UTC 13:00
    # æ¯å¤©æ™šä¸Š 9 ç‚¹ï¼Œä¸€æ¬¡æ€§å¤‡å¥½æ˜å¤©çš„ä¸‰é¡¿é¥­
    - cron: '0 13 * * *'
  
  workflow_dispatch:
    inputs:
      task:
        description: 'æ‰‹åŠ¨æµ‹è¯•ä»»åŠ¡'
        required: true
        default: 'morning'
        type: choice
        options:
        - morning
        - afternoon
        - evening
        - all_daily

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¿®æ”¹ç‚¹ 1: å¿…é¡»èµ‹äºˆä»“åº“å†™å…¥æƒé™ï¼Œå¦åˆ™æ— æ³•ä¿å­˜ JSON æ–‡ä»¶
permissions:
  contents: write

jobs:
  generate-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¿®æ”¹ç‚¹ 2: è®¾ç½® fetch-depth ä¸º 0ï¼Œç¡®ä¿ Git å†å²å®Œæ•´ï¼Œé˜²æ­¢æ¨é€æŠ¥é”™
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - run: echo '${{ secrets.SERVICE_ACCOUNT_JSON }}' > service_account.json
      
      - name: æ‰¹é‡ç”Ÿæˆå†…å®¹
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_RECIPIENTS: ${{ secrets.MAIL_RECIPIENTS }}
        run: |
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”é€‰äº†ç‰¹å®šä»»åŠ¡
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.task }}" != "all_daily" ]; then
             python main.py --task ${{ github.event.inputs.task }}
          else
             # å®šæ—¶è§¦å‘ (æˆ–æ‰‹åŠ¨é€‰äº† all_daily)ï¼šè¿ç»­ç”Ÿæˆä¸‰ç¯‡
             echo "ğŸŒ™ å¼€å§‹ç”Ÿæˆæ˜æ—¥å†…å®¹..."
             
             echo "1ï¸âƒ£ ç”Ÿæˆæ—©æŠ¥..."
             python main.py --task morning
             
             echo "2ï¸âƒ£ ç”ŸæˆåˆæŠ¥..."
             python main.py --task afternoon
             
             echo "3ï¸âƒ£ ç”Ÿæˆæ™šæŠ¥..."
             python main.py --task evening
             
             echo "âœ… å…¨éƒ¨ç”Ÿæˆå®Œæ¯•ï¼è¯·æŸ¥æ”¶ 3 å°é¢„è§ˆé‚®ä»¶ã€‚"
          fi

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¿®æ”¹ç‚¹ 3: æ–°å¢ä¿å­˜æ­¥éª¤ (Commit & Push)
      - name: ä¿å­˜å†å²è®°å½• (ielts_state & evening_history)
        # åªæœ‰å½“å‰é¢çš„ç”Ÿæˆæ­¥éª¤æˆåŠŸäº†ï¼Œæ‰ä¼šæ‰§è¡Œä¿å­˜
        if: success() 
        run: |
          # 1. é…ç½® GitHub æœºå™¨äººèº«ä»½
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 2. æ·»åŠ æ‰€æœ‰å˜åŠ¨ (åŒ…å« ielts_state.json å’Œ evening_history.json)
          git add .
          
          # 3. æäº¤å˜åŠ¨ (å¦‚æœæ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè¿™æ­¥ä¼šè·³è¿‡ï¼Œä¸ä¼šæŠ¥é”™)
          # "|| echo..." æ˜¯ä¸ºäº†é˜²æ­¢å› ä¸ºæ²¡æœ‰æ–°æ–‡ä»¶å¯¼è‡´ Action æŠ¥é”™å˜çº¢
          git diff-index --quiet HEAD || git commit -m "ğŸ¤– Auto-update history logs [skip ci]"
          
          # 4. æ¨é€åˆ°ä»“åº“
          git push
