name: ğŸ¤– æ¯æ—¥å†…å®¹é›†ä¸­ç”Ÿæˆ (æ™šé—´å¤‡ç¨¿)

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 21:00 = UTC 13:00
    # æ¯å¤©æ™šä¸Š 9 ç‚¹ï¼Œä¸€æ¬¡æ€§å¤‡å¥½æ˜å¤©çš„ä¸‰é¡¿é¥­
    - cron: '0 13 * * *'
  
  workflow_dispatch:
    inputs:
      task:
        description: 'æ‰‹åŠ¨æµ‹è¯•ä»»åŠ¡'
        required: true
        default: 'morning'
        type: choice
        options:
        - morning
        - afternoon
        - evening
        - all_daily

# ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¿®æ”¹ç‚¹ 1: å¿…é¡»èµ‹äºˆä»“åº“å†™å…¥æƒé™ï¼Œå¦åˆ™æ— æ³•ä¿å­˜ JSON æ–‡ä»¶
permissions:
  contents: write

jobs:
  generate-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¿®æ”¹ç‚¹ 2: è®¾ç½® fetch-depth ä¸º 0ï¼Œç¡®ä¿ Git å†å²å®Œæ•´ï¼Œé˜²æ­¢æ¨é€æŠ¥é”™
          fetch-depth: 0

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - run: echo '${{ secrets.SERVICE_ACCOUNT_JSON }}' > service_account.json
      
      - name: æ‰¹é‡ç”Ÿæˆå†…å®¹
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_RECIPIENTS: ${{ secrets.MAIL_RECIPIENTS }}
        run: |
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”é€‰äº†ç‰¹å®šä»»åŠ¡
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.task }}" != "all_daily" ]; then
             python main.py --task ${{ github.event.inputs.task }}
          else
             # å®šæ—¶è§¦å‘ (æˆ–æ‰‹åŠ¨é€‰äº† all_daily)ï¼šè¿ç»­ç”Ÿæˆä¸‰ç¯‡
             echo "ğŸŒ™ å¼€å§‹ç”Ÿæˆæ˜æ—¥å†…å®¹..."
             
             echo "1ï¸âƒ£ ç”Ÿæˆæ—©æŠ¥..."
             python main.py --task morning
             
             echo "2ï¸âƒ£ ç”ŸæˆåˆæŠ¥..."
             python main.py --task afternoon
             
             echo "3ï¸âƒ£ ç”Ÿæˆæ™šæŠ¥..."
             python main.py --task evening
             
             echo "âœ… å…¨éƒ¨ç”Ÿæˆå®Œæ¯•ï¼è¯·æŸ¥æ”¶ 3 å°é¢„è§ˆé‚®ä»¶ã€‚"
          fi

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¿®æ”¹ç‚¹ 3: æ–°å¢ä¿å­˜æ­¥éª¤ (Commit & Push)
      - name: ä¿å­˜å†å²è®°å½• (ielts_state & evening_history)
        if: success() 
        run: |
          # 1. é…ç½®èº«ä»½
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 2. âš ï¸ å¼ºåˆ¶æ·»åŠ çŠ¶æ€æ–‡ä»¶ (å…³é”®ä¿®æ”¹ï¼)
          # ä½¿ç”¨ -f å‚æ•°ï¼Œå³ä½¿å®ƒä»¬åœ¨ .gitignore é‡Œä¹Ÿèƒ½è¢«å¼ºåˆ¶æäº¤
          git add -f ielts_state.json
          git add -f evening_history.json
          
          # 3. æ·»åŠ å…¶ä»–å¯èƒ½çš„å˜åŒ–
          git add .
          
          # 4. æäº¤å¹¶æ¨é€
          # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰åˆ™æäº¤
          git diff-index --quiet HEAD || git commit -m "ğŸ¤– Update state files [skip ci]"
          git push
