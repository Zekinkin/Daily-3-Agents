name: ğŸšš æ™ºèƒ½åˆ†å‘ä¸ç›‘æ§

on:
  schedule:
    # --- å®šç‚¹å‘è´§ (Send Mode) ---
    # 1. æ—©æŠ¥: åŒ—äº¬ 08:00 (UTC 00:00)
    - cron: '0 0 * * *'
    # 2. åˆæŠ¥: åŒ—äº¬ 12:00 (UTC 04:00)
    - cron: '0 4 * * *'
    # 3. æ™šæŠ¥: åŒ—äº¬ 21:00 (UTC 13:00)
    # (æ³¨: è¿™æ—¶æ˜¨æ™šç”Ÿæˆçš„æ™šæŠ¥æ­£å¥½å‘å‡ºå»ï¼ŒåŒæ—¶ daily_tasks ä¹Ÿåœ¨ç”Ÿæˆæ˜å¤©çš„ï¼Œäº’ä¸å†²çª)
    - cron: '0 13 * * *'

    # --- æŒç»­ç›‘æ§ (Monitor Mode) ---
    # æ¯å°æ—¶çš„ç¬¬ 30 åˆ†è¿è¡Œä¸€æ¬¡ï¼Œä¸“é—¨å¤„ç† Reject é‡å†™
    - cron: '30 * * * *'

  workflow_dispatch:

jobs:
  dispatch-logic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - run: echo '${{ secrets.SERVICE_ACCOUNT_JSON }}' > service_account.json
      
      - name: æ‰§è¡Œè°ƒåº¦
        env:
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          MAIL_RECIPIENTS: ${{ secrets.MAIL_RECIPIENTS }}
        run: |
          HOUR=$(date +%H)
          MINUTE=$(date +%M)
          
          # 1. åˆ¤æ–­æ˜¯å¦æ˜¯å®šç‚¹å‘é€æ—¶é—´ (å®¹å·® +/- 5åˆ†é’Ÿ)
          # æ³¨æ„ï¼šGitHub Action å¯åŠ¨å¯èƒ½æœ‰å»¶è¿Ÿï¼Œæ‰€ä»¥ä¸éœ€è¦ç²¾ç¡®åˆ°ç§’
          
          # UTC 00:00 -> å‘ Morning
          if [ "$HOUR" == "00" ]; then
             echo "ğŸš€ [æ—¶é—´åˆ°] å‘é€æ—©æŠ¥..."
             python dispatcher.py --mode send --task morning
          fi
          
          # UTC 04:00 -> å‘ Afternoon
          if [ "$HOUR" == "04" ]; then
             echo "ğŸš€ [æ—¶é—´åˆ°] å‘é€åˆæŠ¥..."
             python dispatcher.py --mode send --task afternoon
          fi
          
          # UTC 13:00 -> å‘ Evening
          if [ "$HOUR" == "13" ]; then
             echo "ğŸš€ [æ—¶é—´åˆ°] å‘é€æ™šæŠ¥..."
             python dispatcher.py --mode send --task evening
          fi
          
          # 2. æ— è®ºä½•æ—¶ï¼Œéƒ½è¿è¡Œä¸€æ¬¡ç›‘æ§ï¼Œå¤„ç† Reject
          # è¿™æ ·å³ä½¿ä¸æ˜¯æ•´ç‚¹ï¼Œä½  Reject ä¹‹åï¼ŒåŠå°æ—¶å†…ä¹Ÿä¼šè¢«é‡å†™
          echo "ğŸ‘€ [å·¡é€»] æ£€æŸ¥æ˜¯å¦æœ‰æ‹’ç»ä»»åŠ¡..."
          python dispatcher.py --mode monitor
