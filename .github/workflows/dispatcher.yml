name: ğŸšš æ™ºèƒ½åˆ†å‘ä¸ç›‘æ§

on:
  schedule:
    # 1. æ—©æŠ¥: åŒ—äº¬ 08:00 (UTC 00:00)
    - cron: '0 0 * * *'
    # 2. åˆæŠ¥: åŒ—äº¬ 12:00 (UTC 04:00)
    - cron: '0 4 * * *'
    # 3. æ™šæŠ¥: åŒ—äº¬ 21:00 (UTC 13:00)
    - cron: '0 13 * * *'

    # 4. ç›‘æ§: æ¯å°æ—¶ 30 åˆ†
    - cron: '30 * * * *'

  # å…è®¸æ‰‹åŠ¨å¼ºåˆ¶è§¦å‘
  workflow_dispatch:

jobs:
  dispatch-logic:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - run: echo '${{ secrets.SERVICE_ACCOUNT_JSON }}' > service_account.json
      
      - name: æ‰§è¡Œè°ƒåº¦
        env:
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          MAIL_RECIPIENTS: ${{ secrets.MAIL_RECIPIENTS }}
        run: |
          HOUR=$(date +%H)
          echo "â° å½“å‰ UTC å°æ—¶: $HOUR"
          echo "ğŸ•¹ï¸ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          # ==========================================
          # ğŸš€ åœºæ™¯ 1: æ‰‹åŠ¨å¼ºåˆ¶è§¦å‘ (workflow_dispatch)
          # ==========================================
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "ğŸ”¥ æ‰‹åŠ¨æ¨¡å¼ï¼šå¼ºåˆ¶æ£€æŸ¥æ‰€æœ‰ Pending ä»»åŠ¡..."
             python dispatcher.py --mode send --task morning
             python dispatcher.py --mode send --task afternoon
             python dispatcher.py --mode send --task evening
             
          # ==========================================
          # ğŸ•’ åœºæ™¯ 2: å®šæ—¶è‡ªåŠ¨è§¦å‘ (å®½å®¹æ¨¡å¼)
          # ==========================================
          else
             # UTC 00:00 - 01:59 -> å‘ Morning
             # (é˜²æ­¢ GitHub æ’é˜Ÿå¯¼è‡´æ‹–åˆ° 01 ç‚¹æ‰è¿è¡Œ)
             if [ "$HOUR" == "00" ] || [ "$HOUR" == "01" ]; then
                echo "ğŸš€ [å®šæ—¶] å‘½ä¸­æ—©æŠ¥çª—å£ (00-01 UTC)..."
                python dispatcher.py --mode send --task morning
             fi
             
             # UTC 04:00 - 05:59 -> å‘ Afternoon
             if [ "$HOUR" == "04" ] || [ "$HOUR" == "05" ]; then
                echo "ğŸš€ [å®šæ—¶] å‘½ä¸­åˆæŠ¥çª—å£ (04-05 UTC)..."
                python dispatcher.py --mode send --task afternoon
             fi
             
             # UTC 13:00 - 14:59 -> å‘ Evening
             if [ "$HOUR" == "13" ] || [ "$HOUR" == "14" ]; then
                echo "ğŸš€ [å®šæ—¶] å‘½ä¸­æ™šæŠ¥çª—å£ (13-14 UTC)..."
                python dispatcher.py --mode send --task evening
             fi
          fi
          
          # æœ€ååšä¸€æ¬¡å·¡é€»
          echo "ğŸ‘€ [å·¡é€»] æ£€æŸ¥æ˜¯å¦æœ‰æ‹’ç»ä»»åŠ¡..."
          python dispatcher.py --mode monitor
